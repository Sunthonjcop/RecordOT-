<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลโอทีและการลา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');

        /* --- New UI Theme --- */
        :root {
            --bg-color: #eef0f4;
            --primary-color: #6d5dfc;
            --primary-color-dark: #5b4ddb;
            --grey-light: #e4e6eb;
            --grey-dark: #c8cad1;
            --text-color: #3b4256;
            --holiday-bg: #ffebee;
            --holiday-text: #c62828;
            --holiday-shadow: rgba(229, 57, 53, 0.5);
            --day-shift-glow: #f59e0b;
            --night-shift-glow: #14b8a6;
            --ot-rate1-color: #16a34a; /* green-600 */
            --ot-rate2-color: #2563eb; /* blue-600 */
            --ot-rate3-color: #9333ea; /* purple-600 */
            /* Colors for Leave Types */
            --leave-sick-color: #f59e0b;    /* amber-500 */
            --leave-annual-color: #22c55e; /* green-500 */
            --leave-personal-color: #3b82f6; /* blue-500 */
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .main-container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 2rem;
        }

        .soft-panel {
            background: var(--bg-color);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 8px 8px 16px var(--grey-dark), -8px -8px 16px #ffffff;
        }

        /* --- Calendar Styles --- */
        .calendar-header h2 { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .calendar-nav-btn { background: var(--bg-color); border-radius: 50%; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; transition: all 0.2s ease-in-out; }
        .calendar-nav-btn:hover { color: var(--primary-color); }
        .calendar-nav-btn:active { box-shadow: inset 4px 4px 8px var(--grey-dark), inset -4px -4px 8px #ffffff; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1rem; }
        .calendar-day-name { text-align: center; font-weight: 600; color: var(--text-color); opacity: 0.7; }
        .calendar-day { background: var(--bg-color); border-radius: 1rem; min-height: 6rem; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; cursor: pointer; position: relative; font-weight: 600; box-shadow: 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; transition: all 0.2s ease-in-out; padding: 0.5rem 0.25rem; }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: 6px 6px 12px var(--grey-dark), -6px -6px 12px #ffffff; }
        .calendar-day.is-other-month { opacity: 0.5; box-shadow: none; background: transparent; }
        .calendar-day.is-holiday { background-color: var(--holiday-bg); color: var(--holiday-text); }
        .calendar-day.is-selected { background-color: var(--primary-color); color: white; box-shadow: inset 5px 5px 10px var(--primary-color-dark), inset -5px -5px 10px #8d7fff; transform: translateY(2px); }
        .has-day-shift { box-shadow: inset 4px 0 8px -2px var(--day-shift-glow), 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; }
        .has-night-shift { box-shadow: inset 4px 0 8px -2px var(--night-shift-glow), 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; }
        .is-holiday.has-day-shift { box-shadow: inset 4px 0 8px -2px var(--day-shift-glow), 0 0 15px var(--holiday-shadow), 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; }
        .is-holiday.has-night-shift { box-shadow: inset 4px 0 8px -2px var(--night-shift-glow), 0 0 15px var(--holiday-shadow), 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; }
        .day-content-wrapper { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; z-index: 1; }
        .day-number { font-size: 1.25rem; line-height: 1.2; }
        .ot-lines-container { display: flex; flex-direction: column; align-items: center; line-height: 1; font-size: 0.6rem; }
        .ot-rate-line { font-weight: 700; min-height: 1em; }
        .ot-rate-1 { color: var(--ot-rate1-color); }
        .ot-rate-2 { color: var(--ot-rate2-color); }
        .ot-rate-3 { color: var(--ot-rate3-color); }
        .is-selected .ot-rate-line, .is-selected .day-number { color: white; }

        /* --- Leave Indicator Styles --- */
        .leave-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 18px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            z-index: 2;
        }
        .leave-indicator.sick { background-color: var(--leave-sick-color); }
        .leave-indicator.annual { background-color: var(--leave-annual-color); }
        .leave-indicator.personal { background-color: var(--leave-personal-color); }
        
        /* --- Input Panel Styles --- */
        .data-panel h3 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
        .soft-input { width: 100%; border: none; outline: none; background: var(--bg-color); border-radius: 0.75rem; padding: 0.75rem 1rem; box-shadow: inset 4px 4px 8px var(--grey-dark), inset -4px -4px 8px #ffffff; }
        .btn-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 1rem; }
        .soft-btn { background: var(--bg-color); border-radius: 0.75rem; padding: 0.75rem; font-weight: 600; cursor: pointer; box-shadow: 4px 4px 8px var(--grey-dark), -4px -4px 8px #ffffff; transition: all 0.2s ease-in-out; text-align: center; border: 2px solid transparent; }
        .soft-btn:hover { border-color: var(--primary-color); }
        .soft-btn.is-active { background-color: var(--primary-color); color: white; box-shadow: 0 0 15px var(--primary-color); border-color: var(--primary-color-dark); }
        .soft-btn.is-active-sick { background-color: var(--leave-sick-color); color: white; }
        .soft-btn.is-active-annual { background-color: var(--leave-annual-color); color: white; }
        .soft-btn.is-active-personal { background-color: var(--leave-personal-color); color: white; }
        .btn-primary { background-color: var(--primary-color); color: white; font-size: 1.1rem; }
        .btn-primary:hover { background-color: var(--primary-color-dark); color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-danger:hover { background-color: #d32f2f; color: white; }

        /* --- Compact UI for Inputs --- */
        .compact-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .compact-input-group label {
            font-weight: 500;
            opacity: 0.9;
            flex-basis: 80px;
            flex-shrink: 0;
            margin-bottom: 0;
        }
        .compact-input-group .soft-input { padding: 0.5rem 0.75rem; }
        .compact-input-group .btn-group-compact { flex-grow: 1; }
        .btn-group-compact { display: grid; gap: 0.5rem; }
        #shiftButtons.btn-group-compact { grid-template-columns: repeat(2, 1fr); }
        #otRateButtons.btn-group-compact, #leaveTypeButtons.btn-group-compact { grid-template-columns: repeat(3, 1fr); }
        .btn-group-compact .soft-btn {
            padding: 0.4rem;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 0.6rem;
        }

        /* --- Summary Panel Styles --- */
        .summary-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--grey-light); }
        .summary-list li:last-child { border-bottom: none; }
        .summary-list .label { opacity: 0.8; }
        .summary-list .value { font-weight: 700; }
        .summary-list .leave-summary .value { font-size: 0.9rem; }
        .summary-list .ot-detail { font-size: 0.9rem; padding-left: 1rem; }
        .grand-total { margin-top: 1rem; padding: 1rem; background: var(--bg-color); border-radius: 1rem; box-shadow: inset 4px 4px 8px var(--grey-dark), inset -4px -4px 8px #ffffff; text-align: center; }
        .grand-total .label { font-size: 1rem; opacity: 0.8; }
        .grand-total .value { font-size: 2.5rem; font-weight: 700; color: #2e7d32; transition: all 0.2s ease-in-out; }
        .blurred-text { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.6); }
        
        /* --- Responsive --- */
        @media (max-width: 1024px) { .main-container { grid-template-columns: 1fr; gap: 1.5rem; } .soft-panel { padding: 1.5rem; } }
        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            .main-container { gap: 1rem; }
            .soft-panel { padding: 1rem; border-radius: 1.5rem; }
            .calendar-header h2 { font-size: 1.5rem; }
            .calendar-grid { gap: 0.5rem; }
            .calendar-day { min-height: 5rem; border-radius: 0.75rem; padding-top: 0.5rem; padding-bottom: 24px; }
            .day-number { font-size: 1rem; }
            .ot-lines-container { font-size: 0.55rem; }
            .data-panel h3 { font-size: 1.25rem; }
            .grand-total .value { font-size: 2rem; }
            .summary-list li { flex-wrap: wrap; }
            /* Force 2-column on mobile for input forms */
            #input-forms .grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            #input-forms .compact-input-group label { font-size: 0.8rem; flex-basis: auto; }
            #input-forms .btn-group-compact .soft-btn { font-size: 0.7rem; }
            #input-forms .btn-group { gap: 0.5rem; }
            #input-forms .btn-group .soft-btn { font-size: 0.8rem; padding: 0.5rem;}
        }
    </style>
</head>
<body>

    <div id="auth-container" class="w-full max-w-md mx-auto mb-8">
        <div class="soft-panel">
            <h3 class="text-center text-xl font-bold mb-4">เข้าสู่ระบบ / สมัครสมาชิก</h3>
            <div id="login-form">
                <div class="input-group">
                    <label for="email">อีเมล</label>
                    <input type="email" id="email" class="soft-input" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label for="password">รหัสผ่าน</label>
                    <input type="password" id="password" class="soft-input" placeholder="••••••••">
                </div>
                <div class="btn-group">
                    <button id="loginButton" class="soft-btn btn-primary">เข้าสู่ระบบ</button>
                    <button id="registerButton" class="soft-btn">สมัครสมาชิก</button>
                </div>
            </div>
            <div id="user-info" class="hidden text-center">
                <p id="userEmail" class="mb-4"></p>
                <button id="logoutButton" class="soft-btn btn-danger w-full">ออกจากระบบ</button>
            </div>
        </div>
    </div>
    <div class="main-container hidden">
        <div class="soft-panel">
            <div class="calendar-header flex justify-between items-center mb-6">
                <button id="prevMonth" class="calendar-nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h2 id="currentMonthYear"></h2>
                <button id="nextMonth" class="calendar-nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div id="calendar-day-names" class="calendar-grid mb-2"></div>
            <div id="calendar" class="calendar-grid"></div>
        </div>

        <div class="data-panel flex flex-col gap-8">
            <div class="soft-panel">
                <h3>ข้อมูลประจำวัน</h3>
                <h4 id="selectedDateDisplay" class="text-lg font-semibold mb-4 text-center text-gray-500">โปรดเลือกวันในปฏิทิน</h4>
                
                <div id="input-forms" class="hidden">
                    <div class="grid">
                        
                        <div>
                            <label class="font-bold text-base mb-3 block text-center md:text-left">บันทึกการลา</label>
                            <div class="compact-input-group">
                                <label>ประเภท</label>
                                <div id="leaveTypeButtons" class="btn-group-compact">
                                    <div data-leave-type="sick" class="soft-btn">ลาป่วย</div>
                                    <div data-leave-type="annual" class="soft-btn">ลาพักร้อน</div>
                                    <div data-leave-type="personal" class="soft-btn">ลากิจ</div>
                                </div>
                            </div>
                            <div class="compact-input-group">
                                <label for="leaveHoursInput">ชั่วโมง</label>
                                <input type="number" id="leaveHoursInput" class="soft-input" placeholder="เช่น 8" min="0" step="0.5">
                            </div>
                            <div class="btn-group mt-6">
                                <button id="addLeaveButton" class="soft-btn btn-primary">เพิ่มการลา</button>
                                <button id="clearLeaveButton" class="soft-btn btn-danger">ลบการลา</button>
                            </div>
                        </div>

                        <div>
                            <label class="font-bold text-base mb-3 block text-center md:text-left">บันทึกโอที</label>
                             <div class="compact-input-group">
                                <label>เลือกกะ</label>
                                <div id="shiftButtons" class="btn-group-compact">
                                    <div data-shift="Day" class="soft-btn">☀️ Day</div>
                                    <div data-shift="Night" class="soft-btn">🌙 Night</div>
                                </div>
                            </div>
                            <div class="compact-input-group">
                                <label>อัตราโอที</label>
                                <div id="otRateButtons" class="btn-group-compact">
                                    <div data-rate="1.5" class="soft-btn">1.5x</div>
                                    <div data-rate="2" class="soft-btn">2x</div>
                                    <div data-rate="3" class="soft-btn">3x</div>
                                </div>
                            </div>
                            <div class="compact-input-group">
                                <label for="hoursInput">ชั่วโมง</label>
                                <input type="number" id="hoursInput" class="soft-input" placeholder="0.0" min="0" step="0.5">
                            </div>
                            <div class="btn-group mt-6">
                                <button id="addOtButton" class="soft-btn btn-primary">เพิ่มโอที</button>
                                <button id="clearOtDayButton" class="soft-btn btn-danger">ลบโอที</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="soft-panel">
                <h3>สรุปข้อมูล</h3>
                <ul class="summary-list">
                    <li>
                        <span class="label">เงินเดือน</span>
                        <div class="relative flex items-center gap-2">
                           <input type="number" id="salaryInput" class="soft-input w-32 text-right pr-10" value="16000">
                           <button id="toggleSalaryBtn" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                <svg id="eye-closed" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 1.996 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A10.025 10.025 0 01.458 10c1.274 4.057 5.022 7 9.542 7 1.655 0 3.213-.409 4.588-1.153z" /></svg>
                           </button>
                        </div>
                    </li>
                    <li>
                        <span class="label">ค่าอาหารประจำเดือน</span>
                        <div class="flex items-center gap-2">
                           <input type="number" id="income_regular_meal_allowance" class="soft-input w-24 text-right" value="0">
                        </div>
                    </li>
                     <li>
                        <span class="label">เบี้ยขยัน</span>
                        <div class="flex items-center gap-2">
                           <input type="number" id="income_attendance_bonus" class="soft-input w-24 text-right" value="0">
                        </div>
                    </li>
                    <li class="ot-detail">
                        <span id="ot_label_1_5" class="label">โอที 1.5x (0.0 ชม.)</span>
                        <span id="income_ot_1_5" class="value">0.00</span>
                    </li>
                     <li class="ot-detail">
                        <span id="ot_label_2_0" class="label">โอที 2.0x (0.0 ชม.)</span>
                        <span id="income_ot_2_0" class="value">0.00</span>
                    </li>
                     <li class="ot-detail">
                        <span id="ot_label_3_0" class="label">โอที 3.0x (0.0 ชม.)</span>
                        <span id="income_ot_3_0" class="value">0.00</span>
                    </li>
                     <li>
                        <span class="label">ค่าอาหารโอที</span>
                        <span id="income_ot_meal_allowance_base" class="value">0.00</span>
                    </li>
                     <li>
                        <span class="label">ค่าอาหารโอที (กะดึก)</span>
                        <span id="income_ot_meal_allowance_night" class="value">0.00</span>
                    </li>
                     <li>
                        <span class="label">สวัสดิการกะดึก</span>
                        <span id="income_night_shift_allowance" class="value">0.00</span>
                    </li>
                    <li class="border-t-2 border-gray-200 pt-2 mt-2">
                        <span class="label font-bold">รวมชั่วโมงโอที</span>
                        <span id="summary_total_ot_hours" class="value text-lg">0.0 ชม.</span>
                    </li>
                    <li class="leave-summary border-t-2 border-dashed border-gray-300 pt-2 mt-2">
                        <span class="label">ลาพักร้อน (ใช้ไป/คงเหลือ)</span>
                        <span id="summary_leave_annual" class="value text-green-600">0 / 144 ชม.</span>
                    </li>
                    <li class="leave-summary">
                        <span class="label">ลาป่วย (ใช้ไป/คงเหลือ)</span>
                        <span id="summary_leave_sick" class="value text-amber-600">0 / 240 ชม.</span>
                    </li>
                    <li class="leave-summary">
                        <span class="label">ลากิจ (ใช้ไป/คงเหลือ)</span>
                        <span id="summary_leave_personal" class="value text-blue-600">0 / 56 ชม.</span>
                    </li>
                </ul>
                <div class="grand-total">
                    <div class="label">ยอดรวมทั้งหมด</div>
                    <div id="grandTotalIncome" class="value">0.00</div>
                </div>
                 <div class="btn-group mt-6">
                    <button id="saveDataButton" class="soft-btn btn-primary">💾 บันทึก</button>
                    <button id="clearMonthDataButton" class="soft-btn">🗑️ ล้างเดือนนี้</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCM421haNTvQcpByj0ps_MpN0Q5nYfW1gQ",
        authDomain: "dashboard-342b8.firebaseapp.com",
        projectId: "dashboard-342b8",
        storageBucket: "dashboard-342b8.appspot.com",
        messagingSenderId: "1027322686315",
        appId: "1:1027322686315:web:52a39c659d236235eaba2e",
        measurementId: "G-9LSHYZ9BKP"
      };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>
    <script>
        // No changes needed in JavaScript logic for this layout update.
        // All element IDs are the same, so the script will function correctly.
        
        // ===== START: AUTHENTICATION LOGIC =====
        const authContainer = document.getElementById('auth-container');
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const userEmailDisplay = document.getElementById('userEmail');
        const mainAppContainer = document.querySelector('.main-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const logoutButton = document.getElementById('logoutButton');

        let currentUserId = null;

        registerButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => { alert('สมัครสมาชิกสำเร็จ!'); })
                .catch(error => { alert('เกิดข้อผิดพลาดในการสมัคร: ' + error.message); });
        });

        loginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => { alert('อีเมลหรือรหัสผ่านไม่ถูกต้อง'); });
        });

        logoutButton.addEventListener('click', () => { auth.signOut(); });

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loginForm.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userEmailDisplay.textContent = `ล็อคอินในชื่อ: ${user.email}`;
                mainAppContainer.classList.remove('hidden');
                init();
            } else {
                currentUserId = null;
                loginForm.classList.remove('hidden');
                userInfo.classList.add('hidden');
                mainAppContainer.classList.add('hidden');
                otData = {};
                isInitialized = false;
                if (window.calendarEl) {
                    calendarEl.innerHTML = '';
                    currentMonthYearEl.textContent = '';
                }
            }
        });
        // ===== END: AUTHENTICATION LOGIC =====

        // --- Global variables & Constants ---
        let currentYear, currentMonth, selectedDate = null, otData = {}, selectedOtRate = null, selectedShift = null, selectedLeaveType = null;
        const LEAVE_QUOTAS = { annual: 144, sick: 240, personal: 56 };

        // --- DOM Elements ---
        const calendarEl = document.getElementById('calendar');
        const calendarDayNamesEl = document.getElementById('calendar-day-names');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const selectedDateDisplayEl = document.getElementById('selectedDateDisplay');
        const inputFormsEl = document.getElementById('input-forms');
        const salaryInput = document.getElementById('salaryInput');
        const shiftButtons = document.getElementById('shiftButtons');
        const otRateButtons = document.getElementById('otRateButtons');
        const hoursInput = document.getElementById('hoursInput');
        const addOtButton = document.getElementById('addOtButton');
        const clearOtDayButton = document.getElementById('clearOtDayButton');
        const saveDataButton = document.getElementById('saveDataButton');
        const clearMonthDataButton = document.getElementById('clearMonthDataButton');
        const toggleSalaryBtn = document.getElementById('toggleSalaryBtn');
        const eyeOpenIcon = document.getElementById('eye-open');
        const eyeClosedIcon = document.getElementById('eye-closed');
        
        // --- Leave DOM Elements ---
        const leaveTypeButtons = document.getElementById('leaveTypeButtons');
        const leaveHoursInput = document.getElementById('leaveHoursInput');
        const addLeaveButton = document.getElementById('addLeaveButton');
        const clearLeaveButton = document.getElementById('clearLeaveButton');

        // --- Summary DOM Elements ---
        const income_regular_meal_allowance = document.getElementById('income_regular_meal_allowance');
        const income_ot_meal_allowance_base = document.getElementById('income_ot_meal_allowance_base');
        const income_ot_meal_allowance_night = document.getElementById('income_ot_meal_allowance_night');
        const income_attendance_bonus = document.getElementById('income_attendance_bonus');
        const income_night_shift_allowance = document.getElementById('income_night_shift_allowance');
        const ot_label_1_5 = document.getElementById('ot_label_1_5');
        const income_ot_1_5 = document.getElementById('income_ot_1_5');
        const ot_label_2_0 = document.getElementById('ot_label_2_0');
        const income_ot_2_0 = document.getElementById('income_ot_2_0');
        const ot_label_3_0 = document.getElementById('ot_label_3_0');
        const income_ot_3_0 = document.getElementById('income_ot_3_0');
        const grandTotalIncome = document.getElementById('grandTotalIncome');
        const summary_total_ot_hours = document.getElementById('summary_total_ot_hours');
        const summary_leave_annual = document.getElementById('summary_leave_annual');
        const summary_leave_sick = document.getElementById('summary_leave_sick');
        const summary_leave_personal = document.getElementById('summary_leave_personal');

        const workingDayOverrides = new Set([
            '2025-03-15', '2025-03-29', '2025-04-26', '2025-05-31', 
            '2025-06-07', '2025-06-21', '2025-07-19', '2025-07-26',
            '2025-08-02', '2025-08-30', '2025-09-27', '2025-10-25',
            '2025-11-22', '2025-12-20'
        ]);

        function getThaiHolidays(year) {
            const holidays = {
                2025: {
                    '01-01': "วันขึ้นปีใหม่", '02-12': "วันมาฆบูชา", '04-06': "วันจักรี",
                    '04-07': "ชดเชยวันจักรี", '04-13': "วันสงกรานต์", '04-14': "วันสงกรานต์",
                    '04-15': "วันสงกรานต์", '05-01': "วันแรงงาน", '05-04': "วันฉัตรมงคล",
                    '05-05': "ชดเชยวันฉัตรมงคล", '05-12': "วันวิสาขบูชา", '06-03': "วันเฉลิมฯ พระราชินี",
                    '07-11': "วันอาสาฬหบูชา", '07-12': "วันเข้าพรรษา", '07-14': "ชดเชยวันเข้าพรรษา",
                    '07-28': "วันเฉลิมฯ ร.10", '07-29': "ชดเชยวันเฉลิมฯ", 
                    '08-12': "วันแม่แห่งชาติ", '10-13': "วันนวมินทรมหาราช",
                    '10-23': "วันปิยมหาราช", '12-05': "วันพ่อแห่งชาติ", '12-10': "วันรัฐธรรมนูญ",
                    '12-31': "วันสิ้นปี"
                }
            };
            return holidays[year] || {};
        }

        function formatNumber(value) {
            return parseFloat(value).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function saveData() {
            if (!currentUserId) return;
            const dataToSave = {
                otData: otData,
                salary: salaryInput.value,
                attendanceBonus: income_attendance_bonus.value,
                regularMealAllowance: income_regular_meal_allowance.value
            };
            try {
                await db.collection("users").doc(currentUserId).set(dataToSave);
            } catch (error) {
                console.error("Error saving data to Firestore: ", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
            }
        }

        async function loadData() {
            if (!currentUserId) return;
            const docRef = db.collection("users").doc(currentUserId);
            try {
                const doc = await docRef.get();
                if (doc.exists) {
                    const parsedData = doc.data();
                    otData = parsedData.otData || {};
                    salaryInput.value = parsedData.salary || '16000';
                    income_attendance_bonus.value = parsedData.attendanceBonus || '0';
                    income_regular_meal_allowance.value = parsedData.regularMealAllowance || '0';
                } else {
                    otData = {};
                }
            } catch (error) {
                console.error("Error loading data from Firestore: ", error);
            }
            updateSummary();
        }

        function updateSummary() {
            // --- OT Calculation ---
            let totalOtHours = { 1.5: 0, 2: 0, 3: 0 };
            let nightShiftDays = 0, otMealAllowanceBase = 0, otMealAllowanceNight = 0;
            const salary = parseFloat(salaryInput.value) || 0;
            const hourlyRate = salary / 166;

            for (const dateString in otData) {
                const [year, month] = dateString.split('-').map(Number);
                if (year === currentYear && month - 1 === currentMonth) {
                    const dayData = otData[dateString];
                    let dailyOtHours = 0;
                    if (dayData.entries) {
                        dayData.entries.forEach(ot => {
                            dailyOtHours += ot.hours;
                            if (totalOtHours[ot.rate] !== undefined) totalOtHours[ot.rate] += ot.hours;
                        });
                    }
                    if (dayData.shift === 'Night') nightShiftDays++;
                    if (dailyOtHours >= 1) {
                        otMealAllowanceBase += 84;
                        if (dayData.shift === 'Night') otMealAllowanceNight += 20;
                    }
                }
            }

            const nightShiftAllowance = nightShiftDays * 230;
            const earnings1_5 = totalOtHours[1.5] * 1.5 * hourlyRate;
            const earnings2_0 = totalOtHours[2] * 2 * hourlyRate;
            const earnings3_0 = totalOtHours[3] * 3 * hourlyRate;
            const allOtHours = totalOtHours[1.5] + totalOtHours[2] + totalOtHours[3];
            const allOtEarnings = earnings1_5 + earnings2_0 + earnings3_0;
            const attendanceBonus = parseFloat(income_attendance_bonus.value) || 0;
            const regularMealAllowance = parseFloat(income_regular_meal_allowance.value) || 0;
            const grandTotal = salary + regularMealAllowance + otMealAllowanceBase + otMealAllowanceNight + attendanceBonus + nightShiftAllowance + allOtEarnings;

            income_ot_meal_allowance_base.textContent = formatNumber(otMealAllowanceBase);
            income_ot_meal_allowance_night.textContent = formatNumber(otMealAllowanceNight);
            income_night_shift_allowance.textContent = formatNumber(nightShiftAllowance);
            ot_label_1_5.textContent = `โอที 1.5x (${totalOtHours[1.5].toFixed(1)} ชม.)`;
            income_ot_1_5.textContent = formatNumber(earnings1_5);
            ot_label_2_0.textContent = `โอที 2.0x (${totalOtHours[2].toFixed(1)} ชม.)`;
            income_ot_2_0.textContent = formatNumber(earnings2_0);
            ot_label_3_0.textContent = `โอที 3.0x (${totalOtHours[3].toFixed(1)} ชม.)`;
            income_ot_3_0.textContent = formatNumber(earnings3_0);
            summary_total_ot_hours.textContent = `${allOtHours.toFixed(1)} ชม.`;
            grandTotalIncome.textContent = formatNumber(grandTotal);

            // --- Leave Calculation ---
            const totalLeaveHours = { annual: 0, sick: 0, personal: 0 };
            for (const dateString in otData) {
                const dayData = otData[dateString];
                if (dayData && dayData.leave) {
                    if (totalLeaveHours[dayData.leave.type] !== undefined) {
                        totalLeaveHours[dayData.leave.type] += dayData.leave.hours;
                    }
                }
            }
            
            summary_leave_annual.textContent = `${totalLeaveHours.annual} / ${LEAVE_QUOTAS.annual - totalLeaveHours.annual} ชม.`;
            summary_leave_sick.textContent = `${totalLeaveHours.sick} / ${LEAVE_QUOTAS.sick - totalLeaveHours.sick} ชม.`;
            summary_leave_personal.textContent = `${totalLeaveHours.personal} / ${LEAVE_QUOTAS.personal - totalLeaveHours.personal} ชม.`;

            renderCalendar();
            saveData();
        }
        
        function renderCalendar() {
            if (!calendarEl) return;
            calendarEl.innerHTML = '';
            const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const holidays = getThaiHolidays(currentYear);
            currentMonthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear + 543}`;
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            calendarDayNamesEl.innerHTML = '';
            const dayNames = ["อา", "จ", "อ", "พ", "พฤ", "ศ", "ส"];
            dayNames.forEach(day => {
                const dayNameEl = document.createElement('div');
                dayNameEl.className = 'calendar-day-name';
                dayNameEl.textContent = day;
                calendarDayNamesEl.appendChild(dayNameEl);
            });

            for (let i = 0; i < firstDayOfMonth; i++) calendarEl.appendChild(document.createElement('div')).classList.add('calendar-day', 'is-other-month');

            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.dataset.date = dateString;
                
                const dayOfWeek = new Date(currentYear, currentMonth, day).getDay();
                const monthDayString = dateString.substring(5);
                const dayData = otData[dateString];
                const hasOt = dayData?.entries?.length > 0;
                const isHoliday = (dayOfWeek === 0 || dayOfWeek === 6 || holidays[monthDayString]);
                const isWorkingOverride = workingDayOverrides.has(dateString);
                const isTrueHoliday = isHoliday && !isWorkingOverride;

                let otLinesHtml = '';
                if (hasOt) {
                    const hoursByRate = { '1.5': 0, '2': 0, '3': 0 };
                    dayData.entries.forEach(entry => hoursByRate[entry.rate] += entry.hours);
                    otLinesHtml = `<div class="ot-lines-container">
                        <div class="ot-rate-line ot-rate-1">${hoursByRate['1.5'] > 0 ? hoursByRate['1.5'].toFixed(1).replace('.0','') : '&nbsp;'}</div>
                        <div class="ot-rate-line ot-rate-2">${hoursByRate['2'] > 0 ? hoursByRate['2'].toFixed(1).replace('.0','') : '&nbsp;'}</div>
                        <div class="ot-rate-line ot-rate-3">${hoursByRate['3'] > 0 ? hoursByRate['3'].toFixed(1).replace('.0','') : '&nbsp;'}</div>
                    </div>`;
                }
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'day-content-wrapper';
                contentWrapper.innerHTML = `<div class="day-number">${day}</div>${otLinesHtml}`;
                dayEl.appendChild(contentWrapper);

                if (dayData?.leave) {
                    const leaveIndicator = document.createElement('div');
                    leaveIndicator.className = `leave-indicator ${dayData.leave.type}`;
                    leaveIndicator.textContent = `${dayData.leave.hours.toString().replace('.0', '')} ชม.`;
                    dayEl.appendChild(leaveIndicator);
                }

                if (dateString === selectedDate) dayEl.classList.add('is-selected');
                if (isTrueHoliday) dayEl.classList.add('is-holiday');
                if (dayData?.shift === 'Day') dayEl.classList.add('has-day-shift');
                if (dayData?.shift === 'Night') dayEl.classList.add('has-night-shift');
                
                dayEl.addEventListener('click', () => selectDate(dateString));
                calendarEl.appendChild(dayEl);
            }
        }

        function selectDate(dateString) {
            selectedDate = dateString;
            const holidays = getThaiHolidays(currentYear);
            const holidayName = holidays[dateString.substring(5)];
            const [y, m, d] = dateString.split('-');
            selectedDateDisplayEl.textContent = `วันที่ ${parseInt(d)} ${currentMonthYearEl.textContent}${holidayName ? ` - ${holidayName}` : ''}`;
            inputFormsEl.classList.remove('hidden');

            document.querySelectorAll('#shiftButtons .soft-btn, #otRateButtons .soft-btn').forEach(b => b.classList.remove('is-active'));
            hoursInput.value = '';
            selectedOtRate = null;

            document.querySelectorAll('#leaveTypeButtons .soft-btn').forEach(b => b.classList.remove('is-active', 'is-active-sick', 'is-active-annual', 'is-active-personal'));
            leaveHoursInput.value = '';
            selectedLeaveType = null;
            
            const dayData = otData[selectedDate];
            if (dayData) {
                selectedShift = dayData.shift;
                if (selectedShift) document.querySelector(`#shiftButtons .soft-btn[data-shift="${selectedShift}"]`)?.classList.add('is-active');
                if (dayData.leave) {
                    const { type, hours } = dayData.leave;
                    selectedLeaveType = type;
                    leaveHoursInput.value = hours;
                    const activeBtn = document.querySelector(`#leaveTypeButtons .soft-btn[data-leave-type="${type}"]`);
                    if(activeBtn) activeBtn.classList.add('is-active', `is-active-${type}`);
                }
            } else {
                selectedShift = null;
            }
            renderCalendar();
        }

        function handleShiftSelection(e) {
            const btn = e.target.closest('.soft-btn');
            if (!btn || !selectedDate) return;
            const shift = btn.dataset.shift;
            if (btn.classList.contains('is-active')) {
                btn.classList.remove('is-active'); selectedShift = null;
            } else {
                document.querySelectorAll('#shiftButtons .soft-btn').forEach(b => b.classList.remove('is-active'));
                btn.classList.add('is-active'); selectedShift = shift;
            }
            if (!otData[selectedDate]) otData[selectedDate] = {};
            otData[selectedDate].shift = selectedShift;
            updateSummary();
        }

        function handleRateSelection(e) {
            const btn = e.target.closest('.soft-btn');
            if (!btn) return;
            if(btn.classList.contains('is-active')) {
                btn.classList.remove('is-active'); selectedOtRate = null;
            } else {
                document.querySelectorAll('#otRateButtons .soft-btn').forEach(b => b.classList.remove('is-active'));
                btn.classList.add('is-active'); selectedOtRate = parseFloat(btn.dataset.rate);
            }
        }

        function handleLeaveTypeSelection(e) {
            const btn = e.target.closest('.soft-btn');
            if (!btn) return;
            const type = btn.dataset.leaveType;
            if (btn.classList.contains('is-active')) {
                btn.classList.remove('is-active', `is-active-${type}`);
                selectedLeaveType = null;
            } else {
                document.querySelectorAll('#leaveTypeButtons .soft-btn').forEach(b => b.classList.remove('is-active', 'is-active-sick', 'is-active-annual', 'is-active-personal'));
                btn.classList.add('is-active', `is-active-${type}`);
                selectedLeaveType = type;
            }
        }

        function addOtEntry() {
            if (!selectedDate || selectedOtRate === null) { alert('โปรดเลือกวันและอัตราโอที'); return; }
            const hours = parseFloat(hoursInput.value);
            if (isNaN(hours) || hours <= 0) { alert('โปรดใส่ชั่วโมงที่ถูกต้อง'); return; }
            if (!otData[selectedDate]) otData[selectedDate] = {};
            if (!otData[selectedDate].entries) otData[selectedDate].entries = [];
            otData[selectedDate].entries.push({ hours, rate: selectedOtRate });
            hoursInput.value = '';
            document.querySelectorAll('#otRateButtons .soft-btn').forEach(b => b.classList.remove('is-active'));
            selectedOtRate = null;
            updateSummary();
        }
        
        function addLeaveEntry() {
            if (!selectedDate || !selectedLeaveType) { alert('โปรดเลือกวันและประเภทการลา'); return; }
            const hours = parseFloat(leaveHoursInput.value);
            if (isNaN(hours) || hours <= 0) { alert('โปรดใส่จำนวนชั่วโมงลาที่ถูกต้อง'); return; }
            if (!otData[selectedDate]) otData[selectedDate] = {};
            otData[selectedDate].leave = { type: selectedLeaveType, hours: hours };
            updateSummary();
            alert('บันทึกข้อมูลการลาเรียบร้อย');
        }

        function clearOtForDay() {
            if (!selectedDate) { alert('โปรดเลือกวันที่จะลบ'); return; }
            if (confirm(`ต้องการลบข้อมูล OT ทั้งหมดของวันที่ ${selectedDateDisplayEl.textContent} หรือไม่?`)) {
                if (otData[selectedDate]) otData[selectedDate].entries = [];
                updateSummary();
            }
        }

        function clearLeaveForDay() {
            if (!selectedDate) { alert('โปรดเลือกวันที่จะลบข้อมูลลา'); return; }
            if (otData[selectedDate]?.leave && confirm(`ต้องการลบข้อมูลการลาของวันที่ ${selectedDateDisplayEl.textContent} หรือไม่?`)) {
                delete otData[selectedDate].leave;
                leaveHoursInput.value = '';
                document.querySelectorAll('#leaveTypeButtons .soft-btn').forEach(b => b.classList.remove('is-active', 'is-active-sick', 'is-active-annual', 'is-active-personal'));
                selectedLeaveType = null;
                updateSummary();
            }
        }

        function clearMonthData() {
            if (confirm(`คุณแน่ใจหรือไม่ว่าต้องการล้างข้อมูลทั้งหมดของเดือน ${currentMonthYearEl.textContent}?`)) {
                const monthToClear = String(currentMonth + 1).padStart(2, '0');
                Object.keys(otData).forEach(dateString => {
                    if (dateString.startsWith(`${currentYear}-${monthToClear}`)) {
                        delete otData[dateString];
                    }
                });
                updateSummary();
            }
        }

        // --- Initial Load ---
        let isInitialized = false;
        async function init() {
            if(isInitialized) return;
            isInitialized = true;
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            
            // Set initial blur state
            salaryInput.classList.add('blurred-text');
            grandTotalIncome.classList.add('blurred-text');
            eyeOpenIcon.classList.add('hidden');
            eyeClosedIcon.classList.remove('hidden');

            await loadData();
            
            // Event Listeners
            const navFunction = (isNext) => {
                if(isNext) { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }}
                else { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; }}
                selectedDate = null;
                inputFormsEl.classList.add('hidden');
                selectedDateDisplayEl.textContent = 'โปรดเลือกวันในปฏิทิน';
                updateSummary();
            };
            prevMonthBtn.addEventListener('click', () => navFunction(false));
            nextMonthBtn.addEventListener('click', () => navFunction(true));

            shiftButtons.addEventListener('click', handleShiftSelection);
            otRateButtons.addEventListener('click', handleRateSelection);
            leaveTypeButtons.addEventListener('click', handleLeaveTypeSelection);
            addOtButton.addEventListener('click', addOtEntry);
            addLeaveButton.addEventListener('click', addLeaveEntry);
            clearOtDayButton.addEventListener('click', clearOtForDay);
            clearLeaveButton.addEventListener('click', clearLeaveForDay);

            saveDataButton.addEventListener('click', () => {
                saveData();
                alert('บันทึกข้อมูลลงฐานข้อมูลออนไลน์เรียบร้อยแล้ว!');
            });
            clearMonthDataButton.addEventListener('click', clearMonthData);

            [salaryInput, income_attendance_bonus, income_regular_meal_allowance].forEach(input => {
                input.addEventListener('input', updateSummary);
            });

            toggleSalaryBtn.addEventListener('click', () => {
                salaryInput.classList.toggle('blurred-text');
                grandTotalIncome.classList.toggle('blurred-text');
                eyeOpenIcon.classList.toggle('hidden');
                eyeClosedIcon.classList.toggle('hidden');
            });
        }
    </script>
</body>
</html>
